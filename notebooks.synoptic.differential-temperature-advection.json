{"version":2,"kind":"Notebook","sha256":"35cd1f0ba833393022222f19f23e4b73e052f76bf857e2f6e6e4b1c7fb004da0","slug":"notebooks.synoptic.differential-temperature-advection","location":"/notebooks/synoptic/Differential_Temperature_Advection.ipynb","dependencies":[],"frontmatter":{"title":"Differential Temperature Advection with NARR Data","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"authors":[{"nameParsed":{"literal":"MetPy Maintainers","given":"MetPy","family":"Maintainers"},"name":"MetPy Maintainers","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true},"code":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true}},"github":"https://github.com/projectpythia/metpy-cookbook","copyright":"2025","affiliations":[{"id":"UAlbany","name":"University at Albany (SUNY)","department":"Atmospheric and Environmental Sciences","url":"https://www.albany.edu/daes"},{"id":"CISL","name":"NSF National Center for Atmospheric Research","department":"Computational and Information Systems Lab","url":"https://www.cisl.ucar.edu"},{"id":"Unidata","name":"NSF Unidata","url":"https://www.unidata.ucar.edu"},{"id":"Argonne","name":"Argonne National Laboratory","department":"Environmental Science Division","url":"https://www.anl.gov/evs"},{"id":"CarbonPlan","name":"CarbonPlan","url":"https://carbonplan.org"},{"id":"NVIDIA","name":"NVIDIA Corporation","url":"https://www.nvidia.com/"}],"settings":{"output_matplotlib_strings":"remove"},"numbering":{"title":{"offset":2}},"edit_url":"https://github.com/projectpythia/metpy-cookbook/blob/main/notebooks/synoptic/Differential_Temperature_Advection.ipynb","exports":[{"format":"ipynb","filename":"Differential_Temperature_Advection.ipynb","url":"/metpy-cookbook/build/Differential_Tempera-d5b995fdc3b2552dbb153eacda88fc94.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","data":{"cell_marker":"\"\"\""},"children":[{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"By: Kevin Goebbert","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"MT91k4ri72"}],"key":"X2DkcvhTMU"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"This example creates a four-panel plot to illustrate the difference\nbetween single level temperature advection and a computed differential\ntemperature advection between two layers. This example makes use of NARR\noutput.","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"nwQFWBQdva"}],"key":"gAXF5HylOv"}],"key":"BXgbWuckpi"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import cartopy.crs as ccrs\nimport cartopy.feature as cfeature\nimport matplotlib.gridspec as gridspec\nimport matplotlib.pyplot as plt\nimport metpy.calc as mpcalc\nfrom metpy.units import units\nimport numpy as np\nimport xarray as xr","key":"w702m9Rf0W"},{"type":"output","id":"IphnVAU6ujQEbNPUOwg7l","data":[],"key":"WpyXptPRIf"}],"key":"Wxe6DUxlle"},{"type":"block","kind":"notebook-content","data":{"cell_marker":"######################################################################"},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Data Input","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gLcTPoycwP"}],"identifier":"data-input","label":"Data Input","html_id":"data-input","implicit":true,"key":"X0Sf9K9xtQ"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Use Xarray to access GFS data from THREDDS resource and uses\nmetpy accessor to parse file to make it easy to pull data using\ncommon coordinate names (e.g., vertical) and attach units.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"Tolgqkt8Ku"}],"key":"fjhEAzT0ns"}],"key":"m47Z8Y1HRR"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds = xr.open_dataset('https://thredds.ucar.edu/thredds/dodsC/casestudies/'\n                     'python-gallery/NARR_19930313_1800.nc').metpy.parse_cf()\nds = ds.metpy.assign_latitude_longitude()\n\n# Get lat/lon data from file\nlats = ds.lat\nlons = ds.lon\n\n# Get 700-hPa data and smooth\nlevel = 700 * units.hPa\nhght_700 = mpcalc.smooth_n_point(ds['Geopotential_height_isobaric'].metpy.sel(\n    vertical=level).squeeze(), 9)\ntmpk_700 = mpcalc.smooth_n_point(ds['Temperature_isobaric'].metpy.sel(\n    vertical=level).squeeze(), 9)\nuwnd_700 = mpcalc.smooth_n_point(\n    ds['u-component_of_wind_isobaric'].metpy.sel(vertical=level).squeeze(), 9)\nvwnd_700 = mpcalc.smooth_n_point(\n    ds['v-component_of_wind_isobaric'].metpy.sel(vertical=level).squeeze(), 9)\n\n# Get 300-hPa data and\nlevel = 300 * units.hPa\nhght_300 = mpcalc.smooth_n_point(ds['Geopotential_height_isobaric'].metpy.sel(\n    vertical=level).squeeze(), 9)\ntmpk_300 = mpcalc.smooth_n_point(ds['Temperature_isobaric'].metpy.sel(\n    vertical=level).squeeze(), 9)\nuwnd_300 = mpcalc.smooth_n_point(\n    ds['u-component_of_wind_isobaric'].metpy.sel(vertical=level).squeeze(), 9)\nvwnd_300 = mpcalc.smooth_n_point(\n    ds['v-component_of_wind_isobaric'].metpy.sel(vertical=level).squeeze(), 9)\n\n# Convert Temperatures to degC\ntmpc_700 = tmpk_700.metpy.convert_units('degC')\ntmpc_300 = tmpk_300.metpy.convert_units('degC')\n\n# Get time in a nice datetime object format\nvtime = ds.time.values.astype('datetime64[ms]').astype('O')[0]","key":"Lpf30zAvDe"},{"type":"output","id":"Mv6rXDh6PSOznmEj73vxj","data":[],"key":"blzBu5TARz"}],"key":"m0SWmo1zc2"},{"type":"block","kind":"notebook-content","data":{"cell_marker":"######################################################################"},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Differential Temperature Advection Calculation","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"j8JmZe35R3"}],"identifier":"differential-temperature-advection-calculation","label":"Differential Temperature Advection Calculation","html_id":"differential-temperature-advection-calculation","implicit":true,"key":"p4UifNtOXw"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Use MetPy advection funtion to calculate temperature advection at 700\nand 300 hPa, then manually compute the differential between those two\nlayers. The differential temperature advection is then valid at 500 hPa\n(due to centered differencing) and is the same level that height changes\ndue to absolute vorticity advection is commonly assessed.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"c04ddIQVgN"}],"key":"CZAjuQ0aWy"}],"key":"ET5wC60iB6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Use MetPy advection function to calculate temperature advection at two levels\ntadv_700 = mpcalc.advection(tmpk_700, uwnd_700, vwnd_700)\ntadv_300 = mpcalc.advection(tmpk_300, uwnd_300, vwnd_300)\n\n# Centered finite difference to calculate differential temperature advection\ndiff_tadv = ((tadv_700.data - tadv_300.data)/(400 * units.hPa)).to_base_units()","key":"pcECgSNvRR"},{"type":"output","id":"W9C9YjEzR4C7xL2JJ6LAs","data":[{"output_type":"stream","name":"stderr","text":"/tmp/ipykernel_3607/3635212219.py:2: UserWarning: Vertical dimension number not found. Defaulting to (..., Z, Y, X) order.\n  tadv_700 = mpcalc.advection(tmpk_700, uwnd_700, vwnd_700)\n"},{"output_type":"stream","name":"stderr","text":"/tmp/ipykernel_3607/3635212219.py:3: UserWarning: Vertical dimension number not found. Defaulting to (..., Z, Y, X) order.\n  tadv_300 = mpcalc.advection(tmpk_300, uwnd_300, vwnd_300)\n"}],"key":"yNi2KLyTqq"}],"key":"aig8v8jJyZ"},{"type":"block","kind":"notebook-content","data":{"cell_marker":"######################################################################"},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Make Four Panel Plot","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"T2hKa4DggU"}],"identifier":"make-four-panel-plot","label":"Make Four Panel Plot","html_id":"make-four-panel-plot","implicit":true,"key":"KB5dcvYae1"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"A four panel plot is produced to illustrate the temperature fields at\ntwo levels (700 and 300 hPa), which are common fields to be plotted.\nThen a panel containing the evaluated temperature advection at 700 hPa\nand differential temperature advection between 700 and 300 hPa. Of\nmeteorological significance is the difference between these two\nadvection plots. For the QG Height Tendency equation, the forcing term\nis proportional to the differential temperature advection, which paints\na slightly different picture than just the 700-hPa temperature advection\nalone.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"s0dIBj4Uzt"}],"key":"kRxeC2Pk5z"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"To create the four panel plot it takes a bit of code at this point. The\nfollowing code is segmented into Upper-left, Lower-left, Upper-right,\nLower-right panels using matplotlibâ€™s gridspec to help with spacing.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"sJwv3SCENx"}],"key":"AxHbbeCV8p"}],"key":"lYEwX6cJvY"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Set up plot crs (mapcrs) and the data crs, will need to\n# transform all variables\nmapcrs = ccrs.LambertConformal(central_longitude=-100,\n                               central_latitude=35,\n                               standard_parallels=(30, 60))\ndatacrs = ccrs.PlateCarree()\n\n# Set some common contour interval levels\nclevs_700_tmpc = np.arange(-40, 41, 2)\nclevs_700_hght = np.arange(0, 8000, 30)\nclevs_300_hght = np.arange(0, 10000, 120)\n\n# Create slice to reduce number of wind barbs at plot time\nwind_slice = (slice(None, None, 10), slice(None, None, 10))\n\n# Start figure\nfig = plt.figure(1, figsize=(22, 15))\n\n# Use gridspec to help size elements of plot; small top plot\n# and big bottom plot\ngs = gridspec.GridSpec(nrows=2, ncols=2, height_ratios=[1, 1],\n                       hspace=0.03, wspace=0.03)\n\n\n# Upper-left panel (700-hPa TMPC)\nax1 = plt.subplot(gs[0, 0], projection=mapcrs)\nax1.set_extent([-130, -72, 25, 49], ccrs.PlateCarree())\nax1.add_feature(cfeature.COASTLINE.with_scale('50m'))\nax1.add_feature(cfeature.STATES.with_scale('50m'))\n\ncf = ax1.contourf(lons, lats, tmpc_700, clevs_700_tmpc,\n                  cmap=plt.cm.coolwarm, transform=datacrs)\ncb = plt.colorbar(cf, orientation='horizontal', pad=0, aspect=50)\ncb.set_label(r'$^{\\circ}$C')\n\ncsf = ax1.contour(lons, lats, tmpc_700, clevs_700_tmpc, colors='grey',\n                  linestyles='dashed', transform=datacrs)\nplt.clabel(csf, fmt='%d')\n\ncs = ax1.contour(lons, lats, hght_700, clevs_700_hght, colors='black',\n                 transform=datacrs)\nplt.clabel(cs, fmt='%d')\n\nax1.barbs(lons[wind_slice].values, lats[wind_slice].values,\n          uwnd_700.metpy.convert_units('kt')[wind_slice].values,\n          vwnd_700[wind_slice].metpy.convert_units('kt').values,\n          pivot='middle', color='black', transform=datacrs)\n\nplt.title('700-hPa NARR HGHT (m), TMPC, and Wind (kt)', loc='left')\nplt.title(f'Valid: {vtime}', loc='right')\n\n\n# Lower-left panel (300-hPa TMPC)\nax2 = plt.subplot(gs[1, 0], projection=mapcrs)\nax2.set_extent([-130, -72, 25, 49], ccrs.PlateCarree())\nax2.add_feature(cfeature.COASTLINE.with_scale('50m'))\nax2.add_feature(cfeature.STATES.with_scale('50m'))\n\ncf = ax2.contourf(lons, lats, tmpc_300, range(-60, -24, 2),\n                  cmap=plt.cm.BuPu_r, transform=datacrs)\ncb = plt.colorbar(cf, orientation='horizontal', pad=0, aspect=50)\ncb.set_label(r'$^{\\circ}$C')\n\ncsf = ax2.contour(lons, lats, tmpc_300, range(-60, 0, 2),\n                  colors='grey', linestyles='dashed', transform=datacrs)\nplt.clabel(csf, fmt='%d')\n\ncs = ax2.contour(lons, lats, hght_300, clevs_300_hght, colors='black',\n                 transform=datacrs)\nplt.clabel(cs, fmt='%d')\n\nax2.barbs(lons[wind_slice].values, lats[wind_slice].values,\n          uwnd_300.metpy.convert_units('kt')[wind_slice].values,\n          vwnd_300[wind_slice].metpy.convert_units('kt').values,\n          pivot='middle', color='black', transform=datacrs)\n\nplt.title('300-hPa NARR HGHT (m), TMPC, and Wind (kt)', loc='left')\nplt.title(f'Valid: {vtime}', loc='right')\n\n\n# Upper-right panel (700-hPa TMPC Adv)\nax3 = plt.subplot(gs[0, 1], projection=mapcrs)\nax3.set_extent([-130, -72, 25, 49], ccrs.PlateCarree())\nax3.add_feature(cfeature.COASTLINE.with_scale('50m'))\nax3.add_feature(cfeature.STATES.with_scale('50m'))\n\ncf = ax3.contourf(lons, lats, tadv_700*3600, range(-8, 9, 1),\n                  cmap=plt.cm.coolwarm, transform=datacrs)\ncb = plt.colorbar(cf, orientation='horizontal', pad=0, aspect=50)\ncb.set_label(r'TMPC ADV ($^{\\circ}$C h$^{-1}$)')\n\ncsf = ax3.contour(lons, lats, tmpc_700, clevs_700_tmpc, colors='grey',\n                  linestyles='dashed', transform=datacrs)\nplt.clabel(csf, fmt='%d')\n\ncs = ax3.contour(lons, lats, hght_700, clevs_700_hght, colors='black',\n                 transform=datacrs)\nplt.clabel(cs, fmt='%d')\n\nax3.barbs(lons[wind_slice].values, lats[wind_slice].values,\n          uwnd_700.metpy.convert_units('kt')[wind_slice].values,\n          vwnd_700[wind_slice].metpy.convert_units('kt').values,\n          pivot='middle', color='black', transform=datacrs)\n\nplt.title('700-hPa NARR HGHT (m), TMP ADV (C/h), and Wind (kt)', loc='left')\nplt.title(f'Valid: {vtime}', loc='right')\n\n\n# Lower-right panel (diff TMPC)\nax4 = plt.subplot(gs[1, 1], projection=mapcrs)\nax4.set_extent([-130, -72, 25, 49], ccrs.PlateCarree())\nax4.add_feature(cfeature.COASTLINE.with_scale('50m'))\nax4.add_feature(cfeature.STATES.with_scale('50m'))\n\ncf = ax4.contourf(lons, lats, diff_tadv*1e9, clevs_700_tmpc,\n                  cmap=plt.cm.coolwarm, extend='both', transform=datacrs)\ncb = plt.colorbar(cf, orientation='horizontal', pad=0, aspect=50,\n                  extendrect=True)\ncb.set_label(r'dTMPC ($10^9$ $^{\\circ}$C s$^{-1}$ Pa$^{-1}$)')\n\ncsf = ax4.contour(lons, lats, tmpc_700, clevs_700_tmpc, colors='grey',\n                  linestyles='dashed', transform=datacrs)\nplt.clabel(csf, fmt='%d')\n\ncs = ax4.contour(lons, lats, hght_700, clevs_700_hght, colors='black',\n                 transform=datacrs)\nplt.clabel(cs, fmt='%d')\n\nax4.barbs(lons[wind_slice].values, lats[wind_slice].values,\n          uwnd_700.metpy.convert_units('kt')[wind_slice].values,\n          vwnd_700[wind_slice].metpy.convert_units('kt').values,\n          pivot='middle', color='black', transform=datacrs)\n\nplt.title('700-hPa NARR HGHT (m), Diff. TMP ADV (C/s/Pa), and Wind (kt)', loc='left')\nplt.title(f'Valid: {vtime}', loc='right')","key":"eOc4HWTG2Y"},{"type":"output","id":"zW-ceb3mqBXvAcF9nGYsD","data":[{"output_type":"display_data","metadata":{},"data":{"text/plain":{"content":"<Figure size 2200x1500 with 8 Axes>","content_type":"text/plain"},"image/png":{"content_type":"image/png","hash":"7a2704f117a228375fbef82231a66ea1","path":"/metpy-cookbook/build/7a2704f117a228375fbef82231a66ea1.png"}}}],"key":"iCYyHIA9rq"}],"key":"aGNkEKZg77"}],"key":"oKlsqqtWjd"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Analytic 300-hPa Trough","url":"/notebooks/synoptic/analytic-300hpa-trough","group":"The MetPy Gallery"},"next":{"title":"Geostrophic Wind and Other Calcuations","url":"/notebooks/synoptic/geostrophic-wind-and-few-more","group":"The MetPy Gallery"}}},"domain":"http://localhost:3000"}